# Chatomud

* ruby 3.0.0

* rvm 1.29.11

* bundler 2.2.3

* mysql server 5.7.21

## SETUP

### rvm & ruby

First install rvm, the ruby version manager (https://github.com/rvm/ubuntu_rvm). rvm requires a login shell, so let's get that out of the way everytime that you hop onto the shell:

`/bin/bash --login`

Next:

`sudo apt-get install software-properties-common`

`sudo apt-add-repository -y ppa:rael-gc/rvm`

`sudo apt-get update`

`sudo apt-get install rvm`

Check that it is indeed installed with `rvm -v` after logging out and back in in the shell.

Once we are there, installing ruby is easy:

`rvm install ruby --latest`

`rvm list` this should output something like `ruby-x.x.x`

`rvm --default use x.x.x`

Finally, verify with `ruby -v`.

### install mysql

Next let's install your database server.

`sudo apt-get install mysql-server mysql-client libmysqlclient-dev`

You will be asked to choose a [root_password]. Remember it, and use it to access the mysql cli:

`mysql -u root -p`

When prompted, type in your [root_password]. Now that we are in, we create a user with all privileges on the databases. Possible values for [database] are `chatomud_development` and `chatomud_production`. [password] is the regular user password.

`GRANT ALL PRIVILEGES ON [database].* TO 'chatomud'@'localhost' IDENTIFIED BY '[password]';`

Next we flush, and we are done:

`flush privileges;`

`exit`

### Get the code!

I am going to assume you have git installed in your system, so go ahead and clone the project:

`git clone https://github.com/chatomud/chatomud`

`cd chatomud`

### bundler

You need bundler next. `gem` has been installed along with ruby, so do:

`gem install bundler`

and as always verify with `bundler -v`. If OK, bundle up:

`bundle`

### External data

Some of the necessary data comes from external sources and needs to be generated by running a few commands (all from the base directory):

`cmd/ext/weapon_tables/convert_weapon_tables.sh`

### Seed the data

To populate your database with the starting data run one of the following, [environment] is either `production` or `development`:

`RAILS_ENV=[environment] ./cmd/recreate_db.sh`

This may take a while. Finally start the engine with:

`bundle exec rails s -e production &> exception_output &`

`bundle exec rails s -e development &`

For the production environment we are redirecting error output to a file called `exception_output` you can refer to in the event of a crash. All other logs are kept under `log/[environment]`.

Unless something went wrong you can now connect to the mud under port 1234.

### Redis

AKA the realtime module. First install a few things, primarily tcl:

`sudo apt-get update`

`sudo apt-get install build-essential tcl`

Then move to a temporal folder and follow the common procedure of downloading, untar, make, make test, make install:

`cd /tmp`

`curl -O http://download.redis.io/redis-stable.tar.gz`

`tar xzvf redis-stable.tar.gz`

`cd redis-stable`

`make`

`make test`

`sudo make install`

Now configure redis:

`sudo mkdir /etc/redis`

`sudo cp /tmp/redis-stable/redis.conf /etc/redis`

`sudo vim /etc/redis/redis.conf`

In the file you just opened up for editing, find the `supervised` entry (set to `no`) and change it to `systemd`:

`supervised systemd`

Also, find the `dir` directive and a specify a (not yet created) directory:

`dir /var/lib/redis`

Save and close. Now edit a different file:

`sudo vim /etc/systemd/system/redis.service`

Leave it like this, then save and close:

```
[Unit]
Description=Redis In-Memory Data Store
After=network.target

[Service]
User=redis
Group=redis
ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf
ExecStop=/usr/local/bin/redis-cli shutdown
Restart=always

[Install]
WantedBy=multi-user.target
```

Time to create a user, group and the missing directory from before for redis, unavailable for other users:

`sudo adduser --system --group --no-create-home redis`

`sudo mkdir /var/lib/redis`

`sudo chown redis:redis /var/lib/redis`

`sudo chmod 770 /var/lib/redis`

Now you can start redis:

`sudo systemctl start redis`

Most likely you want redis to boot along with the system. So do:

`sudo systemctl enable redis`

Also, you want to open up port 3030:

`sudo ufw allow 3030`

Finally start the node server that will listen on the redis instance (if you do not have node, check https://github.com/chatomud/chatoweb#node) after you install a couple of gems (install them once you jump into your chatomud root folder):

`npm install socket.io`

`npm install redis`

`node realtime/server.js &`

Or, as a convenience bash file:

`./cmd/dev_realtime.sh`

`./cmd/prod_realtime.sh`

## Env variables

All in all you need to set these environment variables, possibly setting them in your `.bashrc`:

```
export CM_DATABASE_PASSWORD="[password]"
export CM_SOCKET_IO_URI="[hosting]:3030"
export CM_NODEJS_PORT="3030"
export CM_REDIS_HOST="127.0.0.1"
export CM_REDIS_CHANNEL="[generated_channel]"
```

[generated_channel] can be anything. I'd suggest firing up a rails console and doing a `SecureRandom.hex` to generate something random.

## Hosting

If you want to host this somewhere like digital ocean, chances are you were just given root access. To create a regular user to deploy chatomud, first jump in as root:

`ssh root@xxx.xxx.xxx.xxx`

I'm assuming you know about public/private keys and that your public one was set in the host machine by your provider. If it isn't, you should still be able to get access the shell with the password you should have been provided with.

Add a user next:

`adduser chatomud`

Type and retype the password, ignore the rest of questions. Next grant the user sudo privileges, as you may still need to run commands as sudo by prepending them with `sudo` and providing the root password:

`usermod -aG sudo chatomud`

With that done, you can switch to your newly created user:

`su chatomud`

ChatoMud listens on 2 ports, 3000 for API requests (from ChatoWeb) and on 1234 for people connecting to the mud itself. You do not need to open 3000, as the requests will be coming from apache running in the same host (see https://github.com/chatomud/chatoweb#apache), but you do need to open 1234 to accept connections. With ufw this is dead easy:

`sudo ufw allow 1234`

Also, on the system info chatoweb requests from chatomud on every page load we need to include the address it needs to listen for realtime push notifications on, so add this to the launch command, since otherwise it defaults to localhost ([hosting] is e.g. example.com):

`CM_SOCKET_IO_URI=[hosting]:3030`

You are set!

Note: when trying to access the mud under a DNS I was required to add the following to the rails launch command:

`-b 0.0.0.0`

making the commands looks like this:

`bundle exec rails s -b 0.0.0.0 -e production &> exception_output &`

`bundle exec rails s -b 0.0.0.0 -e development &`

I am told that `-b` option makes the server bind to all IP addreses on the machine, that is, localhost and the routable ip address. I don't understand it fully. Check https://stackoverflow.com/questions/29083885/what-does-binding-a-rails-server-to-0-0-0-0-buy-you

### Daemonizing

You can daemonize chatomud to run with `system`. One of the main benefits of this is you can force it to restart after every crash.

So to do this open up a new config file:

`sudo vim /etc/systemd/system/chatomud.service`

And copy this in there, adjusting where necessary (note the environment variables are present):

```
[Service]
Type=simple
User=chatomud
Group=chatomud
WorkingDirectory=/home/chatomud/chatomud
ExecStart=/bin/bash -lc 'bundle exec rails s -b 0.0.0.0 -e production &> exception_output'
TimeoutSec=30
RestartSec=10s
Restart=always
Environment=CM_DATABASE_PASSWORD="[password]"
Environment=CM_SOCKET_IO_URI="hosting:3030"
Environment=CM_NODEJS_PORT="3030"
Environment=CM_REDIS_HOST="127.0.0.1"
Environment=CM_REDIS_CHANNEL="[redis_channel"
Environment=SECRET_KEY_BASE="[secret_key_base]"
[Install]
WantedBy=multi-user.target
```

Then enable it so it starts on system boot, and start it:

`systemctl enable chatomud.service`

`sysctemctl start chatomud.service`

Remember to kill before hand any instances you may have started manually:

`ps ax | grep puma`
`kill -9 [pid]`

A few useful commands. To check the output:

`journalctl -u chatomud.service`

To see if the service is up:

`systemctl status chatomud.service`

Everytime that you change your chatomud.service file run this:

`systemctl daemon-reload`

That's it!
